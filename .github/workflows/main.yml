name: CI
on: [push, pull_request]

jobs:
  tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        haxe-version: [4.2.5, 4.3.7]
        target: [interp, neko, hl, js, cpp, jvm, python, lua, php, cs, java, cppia]
        include:
          - target: interp
            flag: --interp
            output: ""
          - target: neko
            flag: --neko
            output: bin/neko/tests.n
          - target: hl
            flag: --hl
            output: bin/hl/tests.hl
          - target: js
            flag: --js
            output: bin/js/tests.js
          - target: cpp
            flag: --cpp
            output: bin/cpp
          - target: jvm
            flag: --jvm
            output: bin/jvm/tests.jar
          - target: python
            flag: --python
            output: bin/python/tests.py
          - target: lua
            flag: --lua
            output: bin/lua/tests.lua
          - target: php
            flag: --php
            output: bin/php
          - target: cs
            flag: --cs
            output: bin/cs
          - target: java
            flag: --java
            output: bin/java
          - target: cppia
            flag: --cppia
            output: bin/cppia/tests.cppia
    steps:
      - uses: actions/checkout@v4
      - name: Setup Haxe (${{ matrix.haxe-version }})
        uses: krdlab/setup-haxe@v1
        continue-on-error: ${{ matrix.haxe-version == '4.2.5' }}
        with:
          haxe-version: ${{ matrix.haxe-version }}

      - name: Ensure haxelib available
        run: |
          if ! command -v haxelib >/dev/null 2>&1; then
            HAXE_BIN="$HAXE_STD_PATH/.."
            if [ -f "$HAXE_BIN/haxelib" ]; then
              chmod +x "$HAXE_BIN/haxelib"
              echo "$HAXE_BIN" >> $GITHUB_PATH
            fi
          fi
          if ! command -v haxelib >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y haxe
          fi
          if ! command -v haxelib >/dev/null 2>&1; then
            echo "haxelib is missing";
            exit 1;
          fi
          haxelib setup "$HAXE_STD_PATH/../lib"

      - name: Setup runtime (all targets)
        run: |
          set -e
          TARGET="${{ matrix.target }}"

          if [ "$TARGET" = "js" ]; then
            if command -v node >/dev/null 2>&1; then
              NODE_VERSION=$(node -v | sed 's/^v//')
            else
              NODE_VERSION=""
            fi
            if [ "${NODE_VERSION%%.*}" != "20" ]; then
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi
            node --version
          fi

          if [ "$TARGET" = "neko" ]; then
            sudo apt-get update
            sudo apt-get install -y neko
            neko -version
          fi

          if [ "$TARGET" = "java" ] || [ "$TARGET" = "jvm" ]; then
            if ! command -v java >/dev/null 2>&1; then
              sudo apt-get update
              sudo apt-get install -y default-jdk-headless
            fi
            java -version
          fi

          if [ "$TARGET" = "python" ]; then
            if ! command -v python >/dev/null 2>&1; then
              echo "Python is missing; GitHub runner should have it preinstalled."
              exit 1
            fi
            python --version
          fi

          if [ "$TARGET" = "php" ]; then
            if ! command -v php >/dev/null 2>&1; then
              sudo apt-get update
              sudo apt-get install -y php
            fi
            sudo apt-get update
            sudo apt-get install -y php-mbstring
            php -v
          fi

          if [ "$TARGET" = "lua" ] || [ "$TARGET" = "cs" ] || [ "$TARGET" = "hl" ] || [ "$TARGET" = "cpp" ] || [ "$TARGET" = "cppia" ]; then
            sudo apt-get update
            if [ "$TARGET" = "lua" ]; then
              sudo apt-get install -y lua5.3 liblua5.3-dev luarocks
              if ! lua -e "require('rex_pcre2')" >/dev/null 2>&1; then
                sudo luarocks install lrexlib-pcre2
              fi
            fi
            if [ "$TARGET" = "cs" ]; then
              sudo apt-get install -y mono-complete
            fi
            if [ "$TARGET" = "cpp" ] || [ "$TARGET" = "cppia" ]; then
              sudo apt-get install -y build-essential
            fi
            if [ "$TARGET" = "hl" ]; then
              if ! command -v hl >/dev/null 2>&1; then
                if apt-cache show hashlink >/dev/null 2>&1; then
                  sudo apt-get install -y hashlink
                fi
              fi
              if ! command -v hl >/dev/null 2>&1; then
                sudo apt-get install -y git make build-essential libpcre2-dev zlib1g-dev libssl-dev libmbedtls-dev libturbojpeg0-dev libjpeg-turbo8-dev libvorbis-dev libogg-dev libsdl2-dev
                git clone --depth 1 --branch 1.15 https://github.com/HaxeFoundation/hashlink.git /tmp/hashlink
                make -C /tmp/hashlink
                sudo make -C /tmp/hashlink install
                sudo ldconfig
              fi
              hl --version
            fi
          fi

      - name: Set HAXEPATH
        run: |
          echo "HAXEPATH=$HAXE_STD_PATH/.." >> $GITHUB_ENV
      - name: Install & Set-up Vision
        run: |
          haxelib dev vision $GITHUB_WORKSPACE
          haxelib install utest --quiet
          haxelib install format --quiet
          haxelib install hxcpp --quiet
          haxelib install hxjava --quiet
          haxelib install hxcs --quiet
      - name: Build hxcpp tools (cppia runtime)
        if: ${{ matrix.target == 'cppia' }}
        run: |
          HXCPP_PATH=$(haxelib path hxcpp | head -n 1 | tr -d '\r')
          if [ ! -f "$HXCPP_PATH/build-tool/toolchain/haxe-target.xml" ]; then
            haxelib git hxcpp https://github.com/HaxeFoundation/hxcpp
            HXCPP_PATH=$(haxelib path hxcpp | head -n 1 | tr -d '\r')
            pushd "$HXCPP_PATH/tools/hxcpp" > /dev/null
            haxe compile.hxml
            popd > /dev/null
            pushd "$HXCPP_PATH/project" > /dev/null
            neko build.n
            popd > /dev/null
          fi
          pushd "$HXCPP_PATH" > /dev/null
          haxelib run hxcpp project/Build.xml -Dlinux -Dcppia
          popd > /dev/null
      - name: Compile (${{ matrix.target }})
        run: |
          mkdir -p bin
          if [ "${{ matrix.output }}" != "" ]; then
            OUTDIR=$(dirname "${{ matrix.output }}")
            mkdir -p "$OUTDIR"
          fi
          CMD="haxe --class-path tests/generated/src --main Main --library vision --library format --library utest -debug -D vision_skip_golden -D vision_skip_invalid_tests"
          if [ "${{ matrix.target }}" = "java" ] || [ "${{ matrix.target }}" = "jvm" ]; then
            CMD="$CMD --no-inline"
          fi
          if [ "${{ matrix.target }}" = "interp" ]; then
            CMD="$CMD --interp"
          elif [ "${{ matrix.output }}" != "" ]; then
            CMD="$CMD ${{ matrix.flag }} ${{ matrix.output }}"
          else
            CMD="$CMD ${{ matrix.flag }}"
          fi
          echo "$CMD"
          $CMD

      - name: Run (${{ matrix.target }})
        run: |
          if [ "${{ matrix.target }}" = "js" ]; then
            node bin/js/tests.js
          fi
          if [ "${{ matrix.target }}" = "neko" ]; then
            cp bin/neko/tests.n /tmp/tests.n
            neko /tmp/tests.n
          fi
          if [ "${{ matrix.target }}" = "hl" ]; then
            hl bin/hl/tests.hl
          fi
          if [ "${{ matrix.target }}" = "cpp" ]; then
            if [ -x "./bin/cpp/Main" ]; then
              ./bin/cpp/Main
            elif [ -x "./bin/cpp/Main-debug" ]; then
              ./bin/cpp/Main-debug
            else
              echo "CPP executable not found in bin/cpp";
              ls -la bin/cpp
              exit 1
            fi
          fi
          if [ "${{ matrix.target }}" = "jvm" ]; then
            java -jar bin/jvm/tests.jar
          fi
          if [ "${{ matrix.target }}" = "java" ]; then
            if [ -f "bin/java/Main.jar" ]; then
              java -jar bin/java/Main.jar
            elif [ -f "bin/java/Main-Debug.jar" ]; then
              java -jar bin/java/Main-Debug.jar
            else
              java -cp bin/java/obj Main
            fi
          fi
          if [ "${{ matrix.target }}" = "python" ]; then
            python bin/python/tests.py
          fi
          if [ "${{ matrix.target }}" = "lua" ]; then
            printf "return utf8\n" > lua-utf8.lua
            lua bin/lua/tests.lua
          fi
          if [ "${{ matrix.target }}" = "php" ]; then
            php bin/php/index.php
          fi
          if [ "${{ matrix.target }}" = "cs" ]; then
            if [ -f "bin/cs/bin/Main.exe" ]; then
              mono bin/cs/bin/Main.exe
            elif [ -f "bin/cs/bin/Main-Debug.exe" ]; then
              mono bin/cs/bin/Main-Debug.exe
            else
              echo "C# executable not found in bin/cs/bin";
              ls -la bin/cs/bin
              exit 1
            fi
          fi
          if [ "${{ matrix.target }}" = "cppia" ]; then
            CPPPATH=$(haxelib path hxcpp | head -n 1 | tr -d '\r')
            CPPia="${CPPPATH}/bin/Linux/cppia"
            if [ -x "${CPPia}" ]; then
              "${CPPia}" bin/cppia/tests.cppia
            elif command -v cppia >/dev/null 2>&1; then
              cppia bin/cppia/tests.cppia
            else
              echo "cppia runtime not found. Install hxcpp or add cppia to PATH.";
              exit 1
            fi
          fi
          if [ "${{ matrix.target }}" = "interp" ]; then
            echo "Interp already executed in compile step."
          fi
